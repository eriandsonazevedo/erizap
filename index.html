<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.60">
    <title>Cobran√ßaZap - Gerenciador de Cobran√ßas via WhatsApp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/lucide@0.462.0/dist/umd/lucide.js" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.462.0/dist/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, #2563eb 0%, #16a34a 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .header-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 8px;
            text-align: center;
            min-width: 100px;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-content {
            padding: 25px;
        }

        /* Auto Send Service */
        .auto-send-card {
            background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
        }

        .auto-send-header {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #16a34a;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .auto-send-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-radius: 8px;
        }

        /* Forms */
        .form-grid {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        input {
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .phone-input {
            display: flex;
        }

        .phone-prefix {
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            border-right: none;
            padding: 12px;
            border-radius: 8px 0 0 8px;
            color: #6b7280;
        }

        .phone-input input {
            border-radius: 0 8px 8px 0;
            flex: 1;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .btn-success {
            background: linear-gradient(90deg, #16a34a 0%, #15803d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4);
        }

        .btn-warning {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(90deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #d1d5db;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.875rem;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 16px 16px 0 0;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            margin-left: auto;
        }

        /* Log */
        .log-entry {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9fafb;
        }

        .log-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .log-success { background: #dcfce7; color: #16a34a; }
        .log-warning { background: #fef3c7; color: #d97706; }
        .log-error { background: #fee2e2; color: #dc2626; }
        .log-info { background: #dbeafe; color: #2563eb; }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            gap: 4px;
        }

        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-error { background: #fee2e2; color: #dc2626; }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-icon">
                    <i data-lucide="message-circle"></i>
                </div>
                <div>
                    <h1>Cobran√ßaZap</h1>
                    <p>Gerenciador de Cobran√ßas via WhatsApp</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <i data-lucide="users"></i>
                    <div>Clientes</div>
                </div>
                <div class="stat-item">
                    <i data-lucide="dollar-sign"></i>
                    <div>Cobran√ßas</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Auto Send Service -->
        <div class="card auto-send-card">
            <div class="auto-send-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i data-lucide="zap"></i>
                    <span style="font-weight: bold;">Envio Autom√°tico</span>
                    <span id="autoSendBadge" class="badge badge-success hidden">Ativo</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="autoSendToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="card-content">
                <div class="auto-send-info">
                    <div class="info-item">
                        <i data-lucide="alert-triangle" style="color: #f59e0b;"></i>
                        <div>
                            <div style="font-weight: bold;">Pendentes</div>
                            <div id="pendingCount">0 clientes</div>
                        </div>
                    </div>
                    <div class="info-item" id="lastCheckInfo" style="display: none;">
                        <i data-lucide="clock" style="color: #2563eb;"></i>
                        <div>
                            <div style="font-weight: bold;">√öltima Verifica√ß√£o</div>
                            <div id="lastCheckTime">-</div>
                        </div>
                    </div>
                    <div class="info-item" id="nextCheckInfo" style="display: none;">
                        <i data-lucide="clock" style="color: #16a34a;"></i>
                        <div>
                            <div style="font-weight: bold;">Pr√≥xima Verifica√ß√£o</div>
                            <div id="nextCheckTime">-</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(219, 234, 254, 0.7); border-radius: 8px; border: 1px solid #93c5fd;">
                    <p style="font-size: 0.9rem; color: #1e40af;">
                        <strong>Como funciona:</strong> O sistema verifica automaticamente a cada hora (das 8h √†s 20h) 
                        se h√° clientes com vencimento hoje ou em atraso que ainda n√£o receberam mensagem hoje. 
                        As mensagens s√£o enviadas com intervalo de 5 segundos entre elas.
                    </p>
                </div>
            </div>
        </div>

        <!-- Client Form -->
        <div class="card">
            <div class="card-header">
                <i data-lucide="user-plus"></i>
                <h2>Adicionar Cliente</h2>
            </div>
            <div class="card-content">
                <form id="clientForm" class="form-grid">
                    <div class="form-group">
                        <label for="name">Nome Completo</label>
                        <input type="text" id="name" placeholder="Ex: Jo√£o Silva" required>
                    </div>

                    <div class="form-group">
                        <label for="nickname">Apelido (para identifica√ß√£o interna)</label>
                        <input type="text" id="nickname" placeholder="Ex: Jo√£o do Norte">
                    </div>

                    <div class="form-group">
                        <label for="phone">Telefone (DDD + N√∫mero)</label>
                        <div class="phone-input">
                            <span class="phone-prefix">+55</span>
                            <input type="text" id="phone" placeholder="84996069101" pattern="[0-9]{10,11}" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="amount">Valor (R$)</label>
                            <input type="number" id="amount" step="0.01" placeholder="100.00" required>
                        </div>

                        <div class="form-group">
                            <label for="due_date">Vencimento (1-31)</label>
                            <input type="number" id="due_date" min="1" max="31" placeholder="5" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pix_key">Chave PIX</label>
                        <input type="text" id="pix_key" placeholder="84996069101 ou email@exemplo.com" required>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="user-plus"></i>
                        Adicionar Cliente
                    </button>
                </form>
            </div>
        </div>

        <!-- Client Table -->
        <div class="card">
            <div class="card-header">
                <i data-lucide="users"></i>
                <h2>Lista de Clientes (<span id="clientCount">0</span>)</h2>
            </div>
            <div class="card-content">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button id="filterBtn" class="btn btn-secondary btn-sm">
                        <i data-lucide="filter"></i>
                        <span id="filterText">Filtrar Vencimentos de Hoje</span>
                    </button>
                    <button id="importBtn" class="btn btn-secondary btn-sm">
                        <i data-lucide="upload"></i>
                        Importar Excel
                    </button>
                    <button id="exportBtn" class="btn btn-secondary btn-sm">
                        <i data-lucide="download"></i>
                        Exportar Excel
                    </button>
                    <button id="clearDatabaseBtn" class="btn btn-danger btn-sm">
                        <i data-lucide="trash-2"></i>
                        Limpar Base
                    </button>
                    <input type="file" id="importFile" accept=".xlsx,.xls" class="hidden">
                </div>

                <div class="table-container">
                    <table id="clientsTable">
                        <thead>
                            <tr>
                                <th>Nome / Apelido</th>
                                <th>Telefone</th>
                                <th>Valor (R$)</th>
                                <th>Venc.</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody"></tbody>
                    </table>
                </div>

                <div id="emptyState" class="hidden" style="text-align: center; padding: 40px; color: #6b7280;">
                    <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>Nenhum cliente encontrado</p>
                </div>
            </div>
        </div>

        <!-- Message Log -->
        <div class="card">
            <div class="card-header" style="background: linear-gradient(90deg, #7c3aed 0%, #6366f1 100%);">
                <i data-lucide="message-square"></i>
                <h2>Log de Atividades (<span id="logCount">0</span>)</h2>
                <button id="clearLogsBtn" class="btn btn-secondary btn-sm" style="margin-left: auto;">
                    <i data-lucide="trash-2"></i>
                    Limpar
                </button>
            </div>
            <div class="card-content" style="max-height: 400px; overflow-y: auto;">
                <div id="logContainer"></div>
                <div id="emptyLogState" class="hidden" style="text-align: center; padding: 40px; color: #6b7280;">
                    <i data-lucide="message-square" style="width: 48px; height: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>Nenhuma atividade registrada</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <i data-lucide="edit"></i>
                <h2>Editar Cliente</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editForm" class="form-grid">
                    <input type="hidden" id="editClientId">
                    
                    <div class="form-group">
                        <label for="editName">Nome Completo</label>
                        <input type="text" id="editName" required>
                    </div>

                    <div class="form-group">
                        <label for="editNickname">Apelido (para identifica√ß√£o interna)</label>
                        <input type="text" id="editNickname">
                    </div>

                    <div class="form-group">
                        <label for="editPhone">Telefone (DDD + N√∫mero)</label>
                        <div class="phone-input">
                            <span class="phone-prefix">+55</span>
                            <input type="text" id="editPhone" pattern="[0-9]{10,11}" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editAmount">Valor (R$)</label>
                            <input type="number" id="editAmount" step="0.01" required>
                        </div>

                        <div class="form-group">
                            <label for="editDueDate">Vencimento (1-31)</label>
                            <input type="number" id="editDueDate" min="1" max="31" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editPixKey">Chave PIX</label>
                        <input type="text" id="editPixKey" required>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            Salvar Altera√ß√µes
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()" style="flex: 1;">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let clients = [];
        let logs = [];
        let filterToday = true;
        let autoSendEnabled = false;
        let autoSendInterval = null;

        // Initialize icons
        lucide.createIcons();

        // Add log entry
        function addLog(message, type = 'info') {
            const log = {
                id: Date.now().toString(),
                message,
                timestamp: new Date().toISOString(),
                type
            };
            logs.unshift(log);
            logs = logs.slice(0, 100); // Keep only last 100 logs
            saveData();
            updateLogDisplay();
            console.log(`[LOG ${type.toUpperCase()}] ${message}`);
        }

        // Function to check and handle monthly reset
        function checkMonthlyReset(currentClients) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const currentMonthKey = `${currentYear}-${currentMonth}`;
            
            const lastResetMonth = localStorage.getItem('lastResetMonth');
            
            if (lastResetMonth !== currentMonthKey) {
                // New month detected - reset all payment confirmations
                const resetClients = currentClients.map(client => ({
                    ...client,
                    payment_confirmed: false
                }));
                
                // Save the new month
                localStorage.setItem('lastResetMonth', currentMonthKey);
                
                addLog(`Reset autom√°tico mensal executado - todos os clientes resetados para o m√™s ${currentMonth + 1}/${currentYear}`, 'info');
                
                return resetClients;
            }
            
            return currentClients;
        }

        // Load data from localStorage
        function loadData() {
            const savedClients = localStorage.getItem('clients');
            const savedLogs = localStorage.getItem('logs');
            const savedAutoSend = localStorage.getItem('autoSendEnabled');

            let loadedClients = [];

            if (savedClients) {
                loadedClients = JSON.parse(savedClients);
            } else {
                // Default clients
                loadedClients = [
                    {
                        id: '1',
                        name: 'Jo√£o Silva',
                        nickname: 'Jo√£o do Norte',
                        phone: '+5584996069101',
                        amount: 80.00,
                        due_date: 2,
                        pix_key: '84996069101',
                        created_at: new Date().toISOString(),
                        payment_confirmed: false
                    },
                    {
                        id: '2',
                        name: 'Maria Santos',
                        nickname: 'Maria da Loja',
                        phone: '+5584996069102',
                        amount: 100.00,
                        due_date: 3,
                        pix_key: '84996069102',
                        created_at: new Date().toISOString(),
                        payment_confirmed: false
                    },
                    {
                        id: '3',
                        name: 'Jos√© Oliveira',
                        nickname: 'Z√© Mec√¢nico',
                        phone: '+5584996069103',
                        amount: 120.00,
                        due_date: 2,
                        pix_key: '84996069103',
                        created_at: new Date().toISOString(),
                        payment_confirmed: false
                    }
                ];
            }

            // Check for monthly reset
            const resetClients = checkMonthlyReset(loadedClients);
            clients = resetClients;

            if (savedLogs) {
                logs = JSON.parse(savedLogs);
            }

            if (savedAutoSend) {
                autoSendEnabled = JSON.parse(savedAutoSend);
                document.getElementById('autoSendToggle').checked = autoSendEnabled;
                updateAutoSendUI();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('clients', JSON.stringify(clients));
            localStorage.setItem('logs', JSON.stringify(logs));
            localStorage.setItem('autoSendEnabled', JSON.stringify(autoSendEnabled));
        }

        // Clear all database
        function clearDatabase() {
            const firstConfirm = confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° apagar TODOS os dados (clientes, logs e configura√ß√µes).\n\nDeseja realmente continuar?');
            
            if (firstConfirm) {
                const secondConfirm = confirm('üö® √öLTIMA CHANCE: Tem certeza absoluta que deseja apagar toda a base de dados?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!');
                
                if (secondConfirm) {
                    // Clear all data
                    clients = [];
                    logs = [];
                    autoSendEnabled = false;
                    
                    // Clear localStorage
                    localStorage.removeItem('clients');
                    localStorage.removeItem('logs');
                    localStorage.removeItem('autoSendEnabled');
                    localStorage.removeItem('lastResetMonth');
                    
                    // Update UI
                    document.getElementById('autoSendToggle').checked = false;
                    updateAutoSendUI();
                    updateClientDisplay();
                    updateLogDisplay();
                    
                    // Add log entry
                    addLog('üóëÔ∏è Base de dados completamente limpa', 'warning');
                    
                    alert('‚úÖ Base de dados limpa com sucesso!');
                }
            }
        }

        // Update log display
        function updateLogDisplay() {
            const container = document.getElementById('logContainer');
            const emptyState = document.getElementById('emptyLogState');
            const logCount = document.getElementById('logCount');

            logCount.textContent = logs.length;

            if (logs.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = logs.map(log => `
                <div class="log-entry fade-in">
                    <span class="log-badge log-${log.type}">${log.type}</span>
                    <div style="flex: 1;">
                        <p style="margin-bottom: 5px;">${log.message}</p>
                        <p style="font-size: 0.8rem; color: #6b7280;">
                            ${new Date(log.timestamp).toLocaleString('pt-BR')}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        // Update client display
        function updateClientDisplay() {
            const today = new Date().getDate();
            const filteredClients = filterToday 
                ? clients.filter(client => client.due_date <= today && !client.payment_confirmed)
                : clients;

            const clientCount = document.getElementById('clientCount');
            const tableBody = document.getElementById('clientsTableBody');
            const emptyState = document.getElementById('emptyState');
            const filterText = document.getElementById('filterText');

            clientCount.textContent = filteredClients.length;
            filterText.textContent = filterToday ? 'Mostrar Todos os Clientes' : 'Filtrar Vencimentos de Hoje';

            if (filteredClients.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Desktop table
            tableBody.innerHTML = filteredClients.map(client => {
                const canSend = client.due_date <= today && !client.payment_confirmed;
                const statusBadge = client.payment_confirmed 
                    ? '<span class="badge badge-success">Pago</span>'
                    : client.due_date <= today 
                        ? '<span class="badge badge-error">Vencido</span>'
                        : '<span class="badge badge-warning">Pendente</span>';

                const displayName = client.nickname 
                    ? `${client.name} (${client.nickname})`
                    : client.name;

                return `
                    <tr>
                        <td>${displayName}</td>
                        <td>${client.phone}</td>
                        <td>R$ ${client.amount.toFixed(2)}</td>
                        <td>${client.due_date}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                ${canSend ? `<button class="btn btn-success btn-sm" onclick="sendMessage('${client.id}')">
                                    <i data-lucide="send"></i> Enviar
                                </button>` : ''}
                                ${!client.payment_confirmed ? `<button class="btn btn-warning btn-sm" onclick="confirmPayment('${client.id}')">
                                    <i data-lucide="check"></i> Pago
                                </button>` : `<button class="btn btn-secondary btn-sm" onclick="resetPayment('${client.id}')">
                                    <i data-lucide="x"></i> Resetar
                                </button>`}
                                <button class="btn btn-secondary btn-sm" onclick="editClient('${client.id}')">
                                    <i data-lucide="edit"></i> Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteClient('${client.id}')">
                                    <i data-lucide="trash-2"></i> Excluir
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Re-create icons for new elements
            lucide.createIcons();

            // Update pending count
            updatePendingCount();
        }

        // Update pending count
        function updatePendingCount() {
            const today = new Date().getDate();
            const pendingCount = clients.filter(client => 
                client.due_date <= today && !client.payment_confirmed
            ).length;
            document.getElementById('pendingCount').textContent = `${pendingCount} clientes`;
        }

        // Add client
        function addClient(clientData) {
            const newClient = {
                ...clientData,
                id: Date.now().toString(),
                created_at: new Date().toISOString(),
                payment_confirmed: false
            };
            clients.push(newClient);
            saveData();
            updateClientDisplay();
            const displayName = newClient.nickname 
                ? `${newClient.name} (${newClient.nickname})`
                : newClient.name;
            addLog(`Cliente ${displayName} adicionado com sucesso`, 'success');
        }

        // Delete client
        function deleteClient(id) {
            const client = clients.find(c => c.id === id);
            if (client && confirm(`Deseja realmente excluir ${client.name}?`)) {
                clients = clients.filter(c => c.id !== id);
                saveData();
                updateClientDisplay();
                addLog(`Cliente ${client.name} removido`, 'warning');
            }
        }

        // Send message
        function sendMessage(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            const today = new Date().getDate();
            const currentHour = new Date().getHours();
            const greeting = currentHour < 12 ? "Bom dia" : currentHour < 18 ? "Boa tarde" : "Boa noite";
            const status = client.due_date < today ? "" : "";
            // Use the full name for WhatsApp message, not the nickname
            const messageBody = `${greeting}, ${client.name}! ${status}Voc√™ poderia fazer o Pix da mensalidade? Valor: R$${client.amount.toFixed(2)}. Pix: ${client.pix_key}`;
            const encodedMessage = encodeURIComponent(messageBody);
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${client.phone}&text=${encodedMessage}`;

            // Update last sent timestamp
            const clientIndex = clients.findIndex(c => c.id === id);
            if (clientIndex !== -1) {
                clients[clientIndex].last_sent = new Date().toISOString();
                saveData();
                console.log(`Timestamp atualizado para ${client.name}: ${clients[clientIndex].last_sent}`);
            }

            window.open(whatsappUrl, "_blank");
            addLog(`Mensagem enviada para ${client.name} (${client.phone})`, 'success');
        }

        // Confirm payment
        function confirmPayment(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            client.payment_confirmed = true;
            saveData();
            updateClientDisplay();
            addLog(`Pagamento confirmado para ${client.name}`, 'success');
        }

        // Reset payment
        function resetPayment(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            client.payment_confirmed = false;
            saveData();
            updateClientDisplay();
            addLog(`Status de pagamento resetado para ${client.name}`, 'info');
        }

        // Edit client
        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            document.getElementById('editClientId').value = client.id;
            document.getElementById('editName').value = client.name;
            document.getElementById('editNickname').value = client.nickname || '';
            document.getElementById('editPhone').value = client.phone.replace('+55', '');
            document.getElementById('editAmount').value = client.amount;
            document.getElementById('editDueDate').value = client.due_date;
            document.getElementById('editPixKey').value = client.pix_key;

            document.getElementById('editModal').style.display = 'block';
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Update client
        function updateClient(clientData) {
            const id = clientData.id;
            const clientIndex = clients.findIndex(c => c.id === id);
            if (clientIndex === -1) return;

            clients[clientIndex] = { ...clients[clientIndex], ...clientData };
            saveData();
            updateClientDisplay();
            addLog(`Cliente ${clientData.name} editado com sucesso`, 'success');
        }

        // Auto send functions
        function updateAutoSendUI() {
            const badge = document.getElementById('autoSendBadge');
            const lastCheckInfo = document.getElementById('lastCheckInfo');
            const nextCheckInfo = document.getElementById('nextCheckInfo');

            if (autoSendEnabled) {
                badge.classList.remove('hidden');
                lastCheckInfo.style.display = 'flex';
                nextCheckInfo.style.display = 'flex';
                startAutoSend();
            } else {
                badge.classList.add('hidden');
                lastCheckInfo.style.display = 'none';
                nextCheckInfo.style.display = 'none';
                stopAutoSend();
            }
        }

        function startAutoSend() {
            console.log('Iniciando envio autom√°tico...');
            addLog('Sistema de envio autom√°tico iniciado', 'info');
            
            // Clear any existing interval
            if (autoSendInterval) {
                clearInterval(autoSendInterval);
                autoSendInterval = null;
            }

            // Set interval to check every hour (3600000 ms)
            autoSendInterval = setInterval(() => {
                console.log('Executando verifica√ß√£o autom√°tica via intervalo...');
                checkAndSendAutomatically();
            }, 3600000);

            // Run initial check immediately
            setTimeout(() => {
                console.log('Executando verifica√ß√£o inicial...');
                checkAndSendAutomatically();
            }, 1000);
        }

        function stopAutoSend() {
            console.log('Parando envio autom√°tico...');
            addLog('Sistema de envio autom√°tico parado', 'info');
            
            if (autoSendInterval) {
                clearInterval(autoSendInterval);
                autoSendInterval = null;
            }
        }

        function checkAndSendAutomatically() {
            const now = new Date();
            const today = now.getDate();
            const currentHour = now.getHours();

            console.log(`=== VERIFICA√á√ÉO AUTOM√ÅTICA ===`);
            console.log(`Data/Hora: ${now.toLocaleString('pt-BR')}`);
            console.log(`Dia atual: ${today}, Hora: ${currentHour}`);

            // Update last check time
            document.getElementById('lastCheckTime').textContent = now.toLocaleTimeString('pt-BR');

            // Update next check time (1 hour from now)
            const nextCheck = new Date(now.getTime() + 3600000);
            document.getElementById('nextCheckTime').textContent = nextCheck.toLocaleTimeString('pt-BR');

            // Only send between 8 AM and 8 PM
            if (currentHour < 8 || currentHour > 20) {
                console.log('‚ùå Fora do hor√°rio permitido (8h-20h)');
                addLog('Verifica√ß√£o autom√°tica: fora do hor√°rio permitido (8h-20h)', 'warning');
                return;
            }

            console.log('‚úÖ Dentro do hor√°rio permitido');

            // Find overdue clients who haven't received a message today
            const overdueClients = clients.filter(client => {
                const isOverdue = client.due_date <= today && !client.payment_confirmed;
                
                if (!isOverdue) {
                    console.log(`Cliente ${client.name}: n√£o est√° em atraso (vence dia ${client.due_date}, pago: ${client.payment_confirmed})`);
                    return false;
                }
                
                // Check if already sent today
                if (client.last_sent) {
                    const lastSentDate = new Date(client.last_sent);
                    const todayDate = new Date();
                    const isSameDay = lastSentDate.toDateString() === todayDate.toDateString();
                    
                    if (isSameDay) {
                        console.log(`Cliente ${client.name}: j√° recebeu mensagem hoje (${lastSentDate.toLocaleString('pt-BR')})`);
                        return false;
                    }
                }
                
                console.log(`‚úÖ Cliente ${client.name}: apto para receber mensagem autom√°tica`);
                return true;
            });

            console.log(`üìä Total de clientes aptos: ${overdueClients.length}`);

            if (overdueClients.length > 0) {
                addLog(`Enviando mensagens autom√°ticas para ${overdueClients.length} clientes`, 'info');
                
                overdueClients.forEach((client, index) => {
                    // Stagger messages to avoid spam detection (5 seconds between each)
                    setTimeout(() => {
                        console.log(`üì§ Enviando mensagem autom√°tica para ${client.name} (${index + 1}/${overdueClients.length})`);
                        sendMessage(client.id);
                        addLog(`Mensagem autom√°tica enviada para ${client.name}`, 'success');
                    }, index * 5000);
                });
            } else {
                console.log('‚ÑπÔ∏è Nenhum cliente necessita receber mensagem agora');
                addLog('Verifica√ß√£o autom√°tica: nenhuma mensagem necess√°ria', 'info');
            }

            console.log('=== FIM DA VERIFICA√á√ÉO ===\n');
        }

        // Import/Export functions
        function importExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) {
                        addLog('Arquivo Excel vazio ou inv√°lido', 'error');
                        return;
                    }

                    const headers = jsonData[0];
                    const expectedHeaders = ['name', 'phone', 'amount', 'due_date', 'pix_key'];
                    
                    if (!expectedHeaders.every(h => headers.includes(h))) {
                        addLog('Arquivo deve conter as colunas: name, phone, amount, due_date, pix_key', 'error');
                        return;
                    }

                    const importedClients = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length >= 5) {
                            const client = {
                                id: Date.now().toString() + i,
                                name: row[headers.indexOf('name')],
                                nickname: row[headers.indexOf('nickname')] || '',
                                phone: row[headers.indexOf('phone')].toString().startsWith('+55') 
                                    ? row[headers.indexOf('phone')].toString() 
                                    : `+55${row[headers.indexOf('phone')]}`,
                                amount: parseFloat(row[headers.indexOf('amount')]),
                                due_date: parseInt(row[headers.indexOf('due_date')]),
                                pix_key: row[headers.indexOf('pix_key')].toString(),
                                created_at: new Date().toISOString(),
                                payment_confirmed: false
                            };
                            importedClients.push(client);
                        }
                    }

                    clients.push(...importedClients);
                    saveData();
                    updateClientDisplay();
                    addLog(`${importedClients.length} clientes importados com sucesso`, 'success');
                } catch (error) {
                    addLog(`Erro ao importar arquivo: ${error.message}`, 'error');
                }
            };
            reader.readAsBinaryString(file);
        }

        function exportExcel() {
            const exportData = clients.map(client => ({
                name: client.name,
                nickname: client.nickname || '',
                phone: client.phone.replace('+55', ''),
                amount: client.amount,
                due_date: client.due_date,
                pix_key: client.pix_key,
                payment_confirmed: client.payment_confirmed ? 'Sim' : 'N√£o',
                created_at: new Date(client.created_at).toLocaleDateString('pt-BR')
            }));

            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Clientes');

            const date = new Date();
            const dateStr = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
            const fileName = `clientes_export_${dateStr}.xlsx`;

            XLSX.writeFile(workbook, fileName);
            addLog(`Clientes exportados para ${fileName}`, 'success');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Carregando aplica√ß√£o Cobran√ßaZap...');
            loadData();
            updateClientDisplay();
            updateLogDisplay();
            updateAutoSendUI();

            // Client form
            document.getElementById('clientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const phoneInput = document.getElementById('phone').value;
                
                // Validate phone
                const phoneRegex = /^[0-9]{10,11}$/;
                if (!phoneRegex.test(phoneInput)) {
                    alert('Por favor, insira um n√∫mero de telefone v√°lido (DDD + n√∫mero, ex.: 84996069101).');
                    return;
                }

                const clientData = {
                    name: document.getElementById('name').value,
                    nickname: document.getElementById('nickname').value || '',
                    phone: `+55${phoneInput}`,
                    amount: parseFloat(document.getElementById('amount').value),
                    due_date: parseInt(document.getElementById('due_date').value),
                    pix_key: document.getElementById('pix_key').value
                };

                addClient(clientData);
                e.target.reset();
            });

            // Edit form
            document.getElementById('editForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const phoneInput = document.getElementById('editPhone').value;
                
                // Validate phone
                const phoneRegex = /^[0-9]{10,11}$/;
                if (!phoneRegex.test(phoneInput)) {
                    alert('Por favor, insira um n√∫mero de telefone v√°lido (DDD + n√∫mero, ex.: 84996069101).');
                    return;
                }

                const clientData = {
                    id: document.getElementById('editClientId').value,
                    name: document.getElementById('editName').value,
                    nickname: document.getElementById('editNickname').value || '',
                    phone: `+55${phoneInput}`,
                    amount: parseFloat(document.getElementById('editAmount').value),
                    due_date: parseInt(document.getElementById('editDueDate').value),
                    pix_key: document.getElementById('editPixKey').value
                };

                updateClient(clientData);
                closeEditModal();
            });

            // Filter button
            document.getElementById('filterBtn').addEventListener('click', function() {
                filterToday = !filterToday;
                updateClientDisplay();
                addLog(filterToday ? 'Filtro ativado: mostrando apenas vencimentos de hoje' : 'Filtro desativado: mostrando todos os clientes', 'info');
            });

            // Auto send toggle
            document.getElementById('autoSendToggle').addEventListener('change', function() {
                autoSendEnabled = this.checked;
                console.log(`üîÑ Envio autom√°tico ${autoSendEnabled ? 'ATIVADO' : 'DESATIVADO'}`);
                saveData();
                updateAutoSendUI();
                addLog(`Envio autom√°tico ${autoSendEnabled ? 'ativado' : 'desativado'}`, 'info');
            });

            // Import/Export buttons
            document.getElementById('importBtn').addEventListener('click', function() {
                document.getElementById('importFile').click();
            });

            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    importExcel(file);
                }
                e.target.value = '';
            });

            document.getElementById('exportBtn').addEventListener('click', exportExcel);

            // Clear database button
            document.getElementById('clearDatabaseBtn').addEventListener('click', clearDatabase);

            // Clear logs button
            document.getElementById('clearLogsBtn').addEventListener('click', function() {
                if (confirm('Deseja realmente limpar todos os logs?')) {
                    logs = [];
                    saveData();
                    updateLogDisplay();
                    addLog('Logs limpos', 'info');
                }
            });

            // Modal close
            document.querySelector('.close').addEventListener('click', closeEditModal);
            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('editModal')) {
                    closeEditModal();
                }
            });

            console.log('‚úÖ Aplica√ß√£o carregada com sucesso!');
        });
    </script>
</body>
</html>
